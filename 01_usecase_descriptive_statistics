%sql
-- Tasks:
-- Using a CTE and the subscriptins and prducts tables, calcuate the: *minimum monthly revenue *maximum monthly revenue *average monthly revenue *standard deviation of monthly revenue 

-- WITH SUBQUERY: 
SELECT P.PRODUCTNAME,
       MIN(SUB.REV) AS MIN_REV,
       MAX(SUB.REV) AS MAX_REV,
       AVG(SUB.REV) AS AVG_REV,
       STDDEV(SUB.REV) AS STD_DEV_REV
FROM ( SELECT PRODUCTID,
       MONTH(ORDERDATE),
       SUM(REVENUE) AS REV
       FROM SUBSCRIPTIONS
       WHERE YEAR(ORDERDATE) = 2022
       GROUP BY PRODUCTID, MONTH(ORDERDATE)) AS SUB
JOIN PRODUCTS AS P
ON SUB.PRODUCTID = P.PRODUCTID
GROUP BY P.PRODUCTNAME


-- WITH CTE:
WITH SUBS AS (
    SELECT PRODUCTID,
    DATE_TRUNC('month', ORDERDATE) AS MONTH_DATE,
    SUM(REVENUE) AS REV 
    FROM SUBSCRIPTIONS
    WHERE ORDERDATE >= '2022-01-01' AND ORDERDATE <= '2022-12-31'
    GROUP BY PRODUCTID, DATE_TRUNC('month', ORDERDATE)
)

SELECT P.PRODUCTNAME,
       MIN(SUBS.REV) AS MIN_REV,
       MAX(SUBS.REV) AS MAX_REV,
       AVG(SUBS.REV) AS AVG_REV,
       STDDEV(SUBS.REV) AS STD_DEV_REV 
 FROM SUBS
 JOIN PRODUCTS AS P
 ON SUBS.PRODUCTID = P.PRODUCTID
 GROUP BY P.PRODUCTNAME
